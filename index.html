<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Tap Timer</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#007bff" />
<link rel="icon" href="./image.svg">

<style>
  :root{ --bg:#fff; --panel-bg:#fbfdff; --accent:#007bff; --muted:#6b7280; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
  .shell{min-height:100vh;display:flex;flex-direction:column;align-items:stretch;}
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:12px;z-index:10;}
  .title{font-weight:700;font-size:16px;color:#111;}
  .controls{display:flex;gap:10px;align-items:center;}
  .icon-btn{width:44px;height:44px;border-radius:50%;display:inline-grid;place-items:center;border:none;background:transparent;cursor:pointer;box-shadow:0 4px 12px rgba(16,24,40,0.04);padding:6px;}
  .icon-btn:active{transform:scale(.96);outline:none;}
  .icon-btn[hidden]{display:none;}
  .main{display:flex;flex:1;align-items:center;justify-content:center;padding:8px;position:relative;}
  #bigButton{display:flex;align-items:center;justify-content:center;user-select:none;touch-action:manipulation;border-radius:50%;border:8px solid rgba(0,0,0,0.12);background:linear-gradient(180deg,#fff,#f2f6ff);box-shadow:0 20px 40px rgba(2,6,23,0.08);font-weight:800;color:#111;width:min(86vmin,520px);height:min(86vmin,520px);max-width:92vw;max-height:92vw;font-size:clamp(28px,9vmin,92px);cursor:pointer;}
  .meta{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:12px;align-items:center;color:var(--muted);font-size:14px;background:rgba(255,255,255,0.6);padding:6px 10px;border-radius:999px;box-shadow:0 6px 18px rgba(16,24,40,0.04);z-index:5;}
  #listPanel{position:fixed;right:14px;top:74px;bottom:14px;width:340px;max-width:calc(100%-28px);border-radius:12px;background:var(--panel-bg);box-shadow:0 20px 50px rgba(2,6,23,0.12);overflow:auto;padding:12px;z-index:60;transform:translateX(12px) scale(.995);transition:opacity .18s ease,transform .18s ease;opacity:0;pointer-events:none;}
  #listPanel.open{opacity:1;pointer-events:auto;transform:translateX(0) scale(1);}
  #listPanel::-webkit-scrollbar{width:0;height:0;} #listPanel{-ms-overflow-style:none;scrollbar-width:none;}
  .panel-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;}
  .panel-title{font-weight:700;font-size:15px;}
  #tapList{list-style:decimal;padding-left:18px;margin:6px 0 12px 0;}
  #tapList li{margin:10px 0;padding:8px;border-radius:8px;background:rgba(255,255,255,0.7);box-shadow:0 4px 10px rgba(2,6,23,0.04);}
  .tap-ts{font-weight:600;font-size:13px;color:#111;}
  .tap-interval{font-size:13px;color:var(--muted);margin-top:4px;}
  @media (max-width:900px){#listPanel{right:10px;width:92%;top:84px;bottom:12px;}#bigButton{width:min(86vmin,420px);height:min(86vmin,420px);} }
  .ico{width:22px;height:22px;}
  /* iOS install hint overlay */
  .ios-hint {
    position:fixed;left:20px;right:20px;bottom:24px;background:linear-gradient(180deg,#fff,#f8fbff);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.14);z-index:200;display:none;align-items:center;gap:10px;font-size:14px;
  }
  .ios-hint.show{display:flex;}
  .ios-hint .close{margin-left:auto;border:none;background:transparent;cursor:pointer;padding:6px;}
</style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">Tap Timer</div>
      <div class="controls" role="toolbar" aria-label="controls">
        <button id="saveBtn" class="icon-btn" title="Save/download JSON" aria-label="Save session">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M5 20h14v-2H5v2zm7-18l-5 5h3v6h4v-6h3l-5-5z"/></svg>
        </button>
        <button id="resetBtn" class="icon-btn" title="Reset session" aria-label="Reset session">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M13 3a9 9 0 1 0 8.95 8H19a7 7 0 1 1-6.93-6v3l4-4-4-4v3z"/></svg>
        </button>
        <button id="listBtn" class="icon-btn" title="Show session list" aria-label="Show list">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M3 13h2v-2H3v2zm0-6h2V5H3v2zm4 6h14v-2H7v2zm0-6h14V5H7v2zM3 19h2v-2H3v2z"/></svg>
        </button>

        <!-- Install button (hidden until available) -->
        <button id="installBtn" class="icon-btn" title="Install app" aria-label="Install app" hidden>
          <!-- cloud-download icon -->
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M19.35 10.04A7 7 0 0 0 5.64 9.6 5 5 0 0 0 7 19h5v-6h-2l3-4 3 4h-2v6h5a3 3 0 0 0 0-6c-.15 0-.3.01-.45.04z"/></svg>
        </button>
      </div>
    </div>

    <div class="main" role="main">
      <div id="bigButton" role="button" tabindex="0" aria-label="Tap button">0</div>
      <div class="meta" aria-hidden="false">
        <div>Clicks: <strong id="countDisplay">0</strong></div>
        <div>Last interval: <span id="sinceLast" class="muted">—</span></div>
        <!-- vibration support indicator appended here by JS -->
      </div>
    </div>
  </div>

  <aside id="listPanel" aria-hidden="true" role="region" aria-label="Session list panel">
    <div class="panel-header">
      <div class="panel-title">Current session</div>
      <div>
        <button id="closeList" class="icon-btn" title="Close list" aria-label="Close list">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
    </div>
    <div id="listContent" style="margin-bottom:8px;"><div class="muted">Tap the big button to record session. Durations shown are how long each count value was active.</div></div>
    <ol id="tapList" aria-live="polite"></ol>
  </aside>

  <!-- iOS install hint -->
  <div id="iosHint" class="ios-hint" role="dialog" aria-hidden="true">
    <div>
      To install this app on iOS: tap <strong>Share</strong> then choose <strong>Add to Home Screen</strong>.
    </div>
    <button id="closeIosHint" class="close" aria-label="Close">✕</button>
  </div>

<script>
/* Service worker registration (keeps PWA behavior) */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try { await navigator.serviceWorker.register('/service-worker.js'); } catch(e) { /* ignore */ }
  });
}

/* Keys */
const KEY_CURRENT = 'pwacounter_current_v_sw';

/* Elements (plus a small vib support indicator in the .meta area) */
const bigButton = document.getElementById('bigButton');
const countDisplay = document.getElementById('countDisplay');
const sinceLast = document.getElementById('sinceLast');
const tapList = document.getElementById('tapList');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const listBtn = document.getElementById('listBtn');
const listPanel = document.getElementById('listPanel');
const listContent = document.getElementById('listContent');
const closeList = document.getElementById('closeList');
const installBtn = document.getElementById('installBtn');
const iosHint = document.getElementById('iosHint');
const closeIosHint = document.getElementById('closeIosHint');

let currentSession = { createdAt: null, timestamps: [] };

/* Add small vibration-capability indicator inside .meta (if not already present) */
(function ensureVibIndicator(){
  const meta = document.querySelector('.meta');
  if (!document.getElementById('vibSupport')) {
    const span = document.createElement('div');
    span.id = 'vibSupport';
    span.style.marginLeft = '10px';
    span.style.fontSize = '12px';
    span.style.opacity = '0.9';
    meta.appendChild(span);
  }
})();

/* Feature detection */
const supportsVibrate = !!(navigator && typeof navigator.vibrate === 'function');
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
document.getElementById('vibSupport').textContent =
  supportsVibrate && !isIOS ? 'vibration: ok' : (isIOS ? 'vibration: not supported on iOS' : 'vibration: unavailable');

/* Web Audio: one-shot short click tone */
let audioCtx = null;
function ensureAudioContext() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    audioCtx = new AC();
  }
  if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}
function playTapSound() {
  const ctx = ensureAudioContext();
  if (!ctx) return;
  const now = ctx.currentTime;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'square';
  o.frequency.value = 1200;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.5, now + 0.006);
  g.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
  o.connect(g).connect(ctx.destination);
  o.start(now);
  o.stop(now + 0.06);
  o.onended = () => { try { o.disconnect(); g.disconnect(); } catch(e){} };
}

/* Vibration: call synchronously, short pattern */
function doVibrate() {
  if (!supportsVibrate || isIOS) return false;
  try {
    navigator.vibrate([20, 40, 20]);
    return true;
  } catch (e) {
    return false;
  }
}

/* Persistence helpers */
function persistCurrent(){ localStorage.setItem(KEY_CURRENT, JSON.stringify(currentSession)); }
function loadCurrent(){
  const raw = localStorage.getItem(KEY_CURRENT);
  if (raw) {
    try { currentSession = JSON.parse(raw) || { createdAt:null, timestamps:[] }; }
    catch(e){ currentSession = { createdAt:null, timestamps:[] }; }
  }
  updateUI();
}

/* Formatters */
function formatDuration(ms){
  if (ms < 1000) return Math.round(ms) + ' ms';
  let s = Math.floor(ms/1000);
  const days = Math.floor(s/86400); s %= 86400;
  const hours = Math.floor(s/3600); s %= 3600;
  const mins = Math.floor(s/60); const secs = s % 60;
  const parts = [];
  if (days) parts.push(days + 'd');
  if (hours) parts.push(hours + 'h');
  if (mins) parts.push(mins + 'm');
  if (secs) parts.push(secs + 's');
  return parts.join(' ') || '0s';
}
function formatTimestamp(ms){ return new Date(ms).toLocaleString(); }

/* Register tap: record timestamp, play sound, vibrate */
let _lastTrigger = 0;
function registerTapFromGesture(evType){
  const nowMs = Date.now();
  if (nowMs - _lastTrigger < 40) return;
  _lastTrigger = nowMs;

  const vibOk = doVibrate();
  playTapSound();

  const t = Date.now();
  if (!currentSession.createdAt) currentSession.createdAt = t;
  currentSession.timestamps.push(t);
  persistCurrent();
  updateUI();

  if (supportsVibrate && !vibOk) {
    document.getElementById('vibSupport').textContent = 'vibration: failed';
  }
}

/* Build intervals for save */
function buildIntervalsObjectForSave(){
  const ts = currentSession.timestamps;
  const out = {};
  if (!ts.length) return out;
  const savedAt = Date.now();
  for (let i=0;i<ts.length;i++){
    const key = String(i+1);
    if (i < ts.length - 1) out[key] = formatDuration(ts[i+1] - ts[i]);
    else out[key] = formatDuration(savedAt - ts[i]);
  }
  return out;
}
function pad2(n){ return String(n).padStart(2,'0'); }

/* Download JSON */
function downloadJSON(){
  if (!currentSession.timestamps.length) { alert('No taps to save. Click the big button first.'); return; }
  const firstTs = currentSession.createdAt || currentSession.timestamps[0] || Date.now();
  const d = new Date(firstTs);
  const yyyy = d.getFullYear(); const mm = pad2(d.getMonth()+1); const dd = pad2(d.getDate());
  const hh = pad2(d.getHours()); const mi = pad2(d.getMinutes()); const ss = pad2(d.getSeconds());
  const filename = `${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}.json`;
  const payload = { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}:${ss}`, intervals: buildIntervalsObjectForSave() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
}

/* Reset */
function clearCurrent(){
  if (!confirm('Clear current session? This will remove all recorded taps.')) return;
  currentSession = { createdAt: null, timestamps: [] };
  persistCurrent(); updateUI();
}

/* Render list panel */
function renderListPanel(){
  const ts = currentSession.timestamps; const count = ts.length;
  const title = document.querySelector('#listPanel .panel-title');
  title.textContent = `Current session — ${count} tap${count===1?'':'s'}`;
  tapList.innerHTML = '';
  if (!count){ listContent.innerHTML = '<div class="muted">No taps recorded yet. Tap the big button to start.</div>'; return; }
  listContent.innerHTML = '';
  for (let i=0;i<count;i++){
    const li = document.createElement('li');
    const tsVal = ts[i]; const tsText = formatTimestamp(tsVal);
    let intervalText = (i < count-1) ? formatDuration(ts[i+1]-tsVal) : formatDuration(Date.now()-tsVal) + ' (ongoing)';
    li.innerHTML = `<div class="tap-ts">${i+1}. ${tsText}</div><div class="tap-interval">duration at ${i+1}: ${intervalText}</div>`;
    tapList.appendChild(li);
  }
}

/* Update UI */
function updateUI(){
  const ts = currentSession.timestamps; const count = ts.length;
  countDisplay.textContent = count; bigButton.textContent = count;
  if (!count) sinceLast.textContent = '—';
  else if (count >= 2) sinceLast.textContent = formatDuration(ts[count-1]-ts[count-2]);
  else sinceLast.textContent = 'first tap';
  if (listPanel.classList.contains('open')) renderListPanel();
}

/* Event wiring for taps (pointer/touch/click/keyboard) */
bigButton.addEventListener('pointerdown', (ev) => { registerTapFromGesture('pointerdown'); });
bigButton.addEventListener('touchstart', (ev) => { registerTapFromGesture('touchstart'); }, {passive:true});
bigButton.addEventListener('click', (ev) => { registerTapFromGesture('click'); });
bigButton.addEventListener('keydown', (ev)=>{ if (ev.key === ' ' || ev.key === 'Enter') { ev.preventDefault(); registerTapFromGesture('keydown'); } });

saveBtn.addEventListener('click', downloadJSON);
resetBtn.addEventListener('click', clearCurrent);
listBtn.addEventListener('click', ()=>{ const isOpen = listPanel.classList.toggle('open'); listPanel.setAttribute('aria-hidden', !isOpen); if (isOpen) renderListPanel(); });
closeList.addEventListener('click', ()=>{ listPanel.classList.remove('open'); listPanel.setAttribute('aria-hidden','true'); });

/* PWA install handling */
let deferredPrompt = null;

// show install button only if browser triggers beforeinstallprompt OR if iOS we show hint on click
installBtn.hidden = true; // hidden by default

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent automatic prompt and save the event for later
  e.preventDefault();
  deferredPrompt = e;
  installBtn.hidden = false;
  // attach one-time click listener
  installBtn.addEventListener('click', async function onInstallClick(ev){
    if (deferredPrompt) {
      // Show the native prompt
      deferredPrompt.prompt();
      try {
        const choice = await deferredPrompt.userChoice;
        // choice.outcome: "accepted" or "dismissed"
        if (choice.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
      } catch(e){ /* ignore */ }
      deferredPrompt = null;
      installBtn.hidden = true;
    } else if (isIOS) {
      // fallback: show iOS hint
      iosHint.classList.add('show');
      iosHint.setAttribute('aria-hidden', 'false');
    }
    // remove this click listener to prevent duplicates
    installBtn.removeEventListener('click', onInstallClick);
  });
});

// If app is installed, hide button and clear deferred prompt
window.addEventListener('appinstalled', (evt) => {
  deferredPrompt = null;
  installBtn.hidden = true;
  console.log('PWA was installed.');
});

// If there was no beforeinstallprompt fired but the user is on iOS, show the install button so they can get instructions
if (!('onbeforeinstallprompt' in window) && isIOS) {
  // Reveal install button for iOS users (it will show the hint dialog when clicked)
  installBtn.hidden = false;
  installBtn.addEventListener('click', (ev)=>{
    iosHint.classList.add('show');
    iosHint.setAttribute('aria-hidden', 'false');
  });
}

/* Close iOS hint */
closeIosHint.addEventListener('click', ()=>{
  iosHint.classList.remove('show');
  iosHint.setAttribute('aria-hidden', 'true');
});

/* Init */
loadCurrent();
window.addEventListener('beforeunload', persistCurrent);
</script>

</body>
</html>
