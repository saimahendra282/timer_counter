<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Tap Timer</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#007bff" />
<link rel="icon" href="./image.svg">

<style>
  :root{ --bg:#fff; --panel-bg:#fbfdff; --accent:#007bff; --muted:#6b7280; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
  .shell{min-height:100vh;display:flex;flex-direction:column;align-items:stretch;}
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:12px;z-index:10;}
  .title{font-weight:700;font-size:16px;color:#111;}
  .controls{display:flex;gap:10px;align-items:center;}
  .icon-btn{width:44px;height:44px;border-radius:50%;display:inline-grid;place-items:center;border:none;background:transparent;cursor:pointer;box-shadow:0 4px 12px rgba(16,24,40,0.04);}
  .icon-btn:active{transform:scale(.96);}
  .main{display:flex;flex:1;align-items:center;justify-content:center;padding:8px;position:relative;}
  #bigButton{display:flex;align-items:center;justify-content:center;user-select:none;touch-action:manipulation;border-radius:50%;border:8px solid rgba(0,0,0,0.12);background:linear-gradient(180deg,#fff,#f2f6ff);box-shadow:0 20px 40px rgba(2,6,23,0.08);font-weight:800;color:#111;width:min(86vmin,520px);height:min(86vmin,520px);max-width:92vw;max-height:92vw;font-size:clamp(28px,9vmin,92px);}
  .meta{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:12px;align-items:center;color:var(--muted);font-size:14px;background:rgba(255,255,255,0.6);padding:6px 10px;border-radius:999px;box-shadow:0 6px 18px rgba(16,24,40,0.04);}
  #listPanel{position:fixed;right:14px;top:74px;bottom:14px;width:340px;max-width:calc(100%-28px);border-radius:12px;background:var(--panel-bg);box-shadow:0 20px 50px rgba(2,6,23,0.12);overflow:auto;padding:12px;z-index:60;transform:translateX(12px) scale(.995);transition:opacity .18s ease,transform .18s ease;opacity:0;pointer-events:none;}
  #listPanel.open{opacity:1;pointer-events:auto;transform:translateX(0) scale(1);}
  #listPanel::-webkit-scrollbar{width:0;height:0;} #listPanel{-ms-overflow-style:none;scrollbar-width:none;}
  .panel-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;}
  .panel-title{font-weight:700;font-size:15px;}
  #tapList{list-style:decimal;padding-left:18px;margin:6px 0 12px 0;}
  #tapList li{margin:10px 0;padding:8px;border-radius:8px;background:rgba(255,255,255,0.7);box-shadow:0 4px 10px rgba(2,6,23,0.04);}
  .tap-ts{font-weight:600;font-size:13px;color:#111;}
  .tap-interval{font-size:13px;color:var(--muted);margin-top:4px;}
  @media (max-width:900px){#listPanel{right:10px;width:92%;top:84px;bottom:12px;}#bigButton{width:min(86vmin,420px);height:min(86vmin,420px);}}
  .ico{width:22px;height:22px;}
</style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">Tap Timer</div>
      <div class="controls" role="toolbar" aria-label="controls">
        <button id="saveBtn" class="icon-btn" title="Save/download JSON">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M5 20h14v-2H5v2zm7-18l-5 5h3v6h4v-6h3l-5-5z"/></svg>
        </button>
        <button id="resetBtn" class="icon-btn" title="Reset session">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M13 3a9 9 0 1 0 8.95 8H19a7 7 0 1 1-6.93-6v3l4-4-4-4v3z"/></svg>
        </button>
        <button id="listBtn" class="icon-btn" title="Show session list">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M3 13h2v-2H3v2zm0-6h2V5H3v2zm4 6h14v-2H7v2zm0-6h14V5H7v2zM3 19h2v-2H3v2z"/></svg>
        </button>
      </div>
    </div>

    <div class="main" role="main">
      <div id="bigButton" role="button" tabindex="0" aria-label="Tap button">0</div>
      <div class="meta" aria-hidden="false">
        <div>Clicks: <strong id="countDisplay">0</strong></div>
        <div>Last interval: <span id="sinceLast" class="muted">—</span></div>
      </div>
    </div>
  </div>

  <aside id="listPanel" aria-hidden="true" role="region" aria-label="Session list panel">
    <div class="panel-header">
      <div class="panel-title">Current session</div>
      <div>
        <button id="closeList" class="icon-btn" title="Close list" aria-label="Close list">
          <svg class="ico" viewBox="0 0 24 24"><path fill="#111" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
    </div>
    <div id="listContent" style="margin-bottom:8px;"><div class="muted">Tap the big button to record session. Durations shown are how long each count value was active.</div></div>
    <ol id="tapList" aria-live="polite"></ol>
  </aside>
<script>
/* Service worker registration (keeps PWA behavior) */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try { await navigator.serviceWorker.register('/service-worker.js'); } catch(e) { /* ignore */ }
  });
}

/* Keys */
const KEY_CURRENT = 'pwacounter_current_v_sw';

/* Elements (plus a small vib support indicator in the .meta area) */
const bigButton = document.getElementById('bigButton');
const countDisplay = document.getElementById('countDisplay');
const sinceLast = document.getElementById('sinceLast');
const tapList = document.getElementById('tapList');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const listBtn = document.getElementById('listBtn');
const listPanel = document.getElementById('listPanel');
const listContent = document.getElementById('listContent');
const closeList = document.getElementById('closeList');
let currentSession = { createdAt: null, timestamps: [] };

/* Add small vibration-capability indicator inside .meta (if not already present) */
(function ensureVibIndicator(){
  const meta = document.querySelector('.meta');
  if (!document.getElementById('vibSupport')) {
    const span = document.createElement('div');
    span.id = 'vibSupport';
    span.style.marginLeft = '10px';
    span.style.fontSize = '12px';
    span.style.opacity = '0.9';
    meta.appendChild(span);
  }
})();

/* Feature detection */
const supportsVibrate = !!(navigator && typeof navigator.vibrate === 'function');
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
document.getElementById('vibSupport').textContent =
  supportsVibrate && !isIOS ? 'vibration: ok' : (isIOS ? 'vibration: not supported on iOS' : 'vibration: unavailable');

/* Web Audio: one-shot short click tone */
let audioCtx = null;
function ensureAudioContext() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    audioCtx = new AC();
  }
  // resume may return a Promise; call it but don't await (must remain in gesture)
  if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}
function playTapSound() {
  const ctx = ensureAudioContext();
  if (!ctx) return;
  const now = ctx.currentTime;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'square';
  o.frequency.value = 1200;
  // very short percussive envelope
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.5, now + 0.006);
  g.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
  o.connect(g).connect(ctx.destination);
  o.start(now);
  o.stop(now + 0.06);
  o.onended = () => { try { o.disconnect(); g.disconnect(); } catch(e){} };
}

/* Vibration: call synchronously, short pattern */
function doVibrate() {
  if (!supportsVibrate || isIOS) return false;
  try {
    // pattern: vibrate - pause - vibrate to feel like a tap
    navigator.vibrate([20, 40, 20]);
    return true;
  } catch (e) {
    return false;
  }
}

/* Persistence helpers */
function persistCurrent(){ localStorage.setItem(KEY_CURRENT, JSON.stringify(currentSession)); }
function loadCurrent(){
  const raw = localStorage.getItem(KEY_CURRENT);
  if (raw) {
    try { currentSession = JSON.parse(raw) || { createdAt:null, timestamps:[] }; }
    catch(e){ currentSession = { createdAt:null, timestamps:[] }; }
  }
  updateUI();
}

/* Formatters */
function formatDuration(ms){
  if (ms < 1000) return Math.round(ms) + ' ms';
  let s = Math.floor(ms/1000);
  const days = Math.floor(s/86400); s %= 86400;
  const hours = Math.floor(s/3600); s %= 3600;
  const mins = Math.floor(s/60); const secs = s % 60;
  const parts = [];
  if (days) parts.push(days + 'd');
  if (hours) parts.push(hours + 'h');
  if (mins) parts.push(mins + 'm');
  if (secs) parts.push(secs + 's');
  return parts.join(' ') || '0s';
}
function formatTimestamp(ms){ return new Date(ms).toLocaleString(); }

/* Register tap: record timestamp, play sound, vibrate
   Keep all vibration/audio calls synchronous in the user gesture handler.
*/
let _lastTrigger = 0; // debounce to avoid duplicate events (some platforms fire pointerdown+touchstart+click)
function registerTapFromGesture(evType){
  const nowMs = Date.now();
  if (nowMs - _lastTrigger < 40) return; // ignore duplicates within 40ms
  _lastTrigger = nowMs;

  // Immediately trigger vibration (synchronous)
  const vibOk = doVibrate();

  // Trigger audio; resume will be attempted but not awaited (keeps it synchronous-ish)
  playTapSound();

  // record timestamp
  const t = Date.now();
  if (!currentSession.createdAt) currentSession.createdAt = t;
  currentSession.timestamps.push(t);
  persistCurrent();
  updateUI();

  // optional: update vibSupport text if it failed unexpectedly
  if (supportsVibrate && !vibOk) {
    document.getElementById('vibSupport').textContent = 'vibration: failed';
  }
}

/* Build intervals for save */
function buildIntervalsObjectForSave(){
  const ts = currentSession.timestamps;
  const out = {};
  if (!ts.length) return out;
  const savedAt = Date.now();
  for (let i=0;i<ts.length;i++){
    const key = String(i+1);
    if (i < ts.length - 1) out[key] = formatDuration(ts[i+1] - ts[i]);
    else out[key] = formatDuration(savedAt - ts[i]);
  }
  return out;
}
function pad2(n){ return String(n).padStart(2,'0'); }

/* Download JSON */
function downloadJSON(){
  if (!currentSession.timestamps.length) { alert('No taps to save. Click the big button first.'); return; }
  const firstTs = currentSession.createdAt || currentSession.timestamps[0] || Date.now();
  const d = new Date(firstTs);
  const yyyy = d.getFullYear(); const mm = pad2(d.getMonth()+1); const dd = pad2(d.getDate());
  const hh = pad2(d.getHours()); const mi = pad2(d.getMinutes()); const ss = pad2(d.getSeconds());
  const filename = `${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}.json`;
  const payload = { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}:${ss}`, intervals: buildIntervalsObjectForSave() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
}

/* Reset */
function clearCurrent(){
  if (!confirm('Clear current session? This will remove all recorded taps.')) return;
  currentSession = { createdAt: null, timestamps: [] };
  persistCurrent(); updateUI();
}

/* Render list panel */
function renderListPanel(){
  const ts = currentSession.timestamps; const count = ts.length;
  const title = document.querySelector('#listPanel .panel-title');
  title.textContent = `Current session — ${count} tap${count===1?'':'s'}`;
  tapList.innerHTML = '';
  if (!count){ listContent.innerHTML = '<div class="muted">No taps recorded yet. Tap the big button to start.</div>'; return; }
  listContent.innerHTML = '';
  for (let i=0;i<count;i++){
    const li = document.createElement('li');
    const tsVal = ts[i]; const tsText = formatTimestamp(tsVal);
    let intervalText = (i < count-1) ? formatDuration(ts[i+1]-tsVal) : formatDuration(Date.now()-tsVal) + ' (ongoing)';
    li.innerHTML = `<div class="tap-ts">${i+1}. ${tsText}</div><div class="tap-interval">duration at ${i+1}: ${intervalText}</div>`;
    tapList.appendChild(li);
  }
}

/* Update UI */
function updateUI(){
  const ts = currentSession.timestamps; const count = ts.length;
  countDisplay.textContent = count; bigButton.textContent = count;
  if (!count) sinceLast.textContent = '—';
  else if (count >= 2) sinceLast.textContent = formatDuration(ts[count-1]-ts[count-2]);
  else sinceLast.textContent = 'first tap';
  if (listPanel.classList.contains('open')) renderListPanel();
}

/* Event wiring
   Prefer pointerdown (touch/mouse/stylus). Add touchstart fallback and click fallback.
   Keep keyboard (Space/Enter) support.
*/
bigButton.addEventListener('pointerdown', (ev) => {
  registerTapFromGesture('pointerdown');
});
// fallback for very old browsers
bigButton.addEventListener('touchstart', (ev) => {
  registerTapFromGesture('touchstart');
}, {passive: true});
// last-resort fallback (shouldn't double-fire thanks to debounce)
bigButton.addEventListener('click', (ev) => {
  registerTapFromGesture('click');
});
bigButton.addEventListener('keydown', (ev)=>{
  if (ev.key === ' ' || ev.key === 'Enter') {
    ev.preventDefault();
    registerTapFromGesture('keydown');
  }
});

saveBtn.addEventListener('click', downloadJSON);
resetBtn.addEventListener('click', clearCurrent);
listBtn.addEventListener('click', ()=>{
  const isOpen = listPanel.classList.toggle('open');
  listPanel.setAttribute('aria-hidden', !isOpen);
  if (isOpen) renderListPanel();
});
closeList.addEventListener('click', ()=>{ listPanel.classList.remove('open'); listPanel.setAttribute('aria-hidden','true'); });

/* Init */
loadCurrent();
window.addEventListener('beforeunload', persistCurrent);
</script>


</body>
</html>
