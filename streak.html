<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daily Streak</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: #f8fafc;
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .app {
    width: 100%;
    max-width: 420px;
    background: white;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 12px 32px rgba(0,0,0,.08);
  }

  h1 {
    text-align: center;
    margin: 0 0 8px;
  }

  .streak {
    text-align: center;
    font-weight: 600;
    margin-bottom: 14px;
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 22px;
  }

  .weekday {
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
  }

  .day {
    position: relative;
    text-align: center;
    padding: 12px 0;
    border-radius: 12px;
    background: #f1f5f9;
    font-size: 14px;
  }

  .day.today {
    border: 2px solid #fb923c;
    font-weight: 700;
  }

  .day.future { opacity: .35; }
  .day.past { opacity: .7; }

  .day.done {
    background: #dcfce7;
    font-weight: 700;
  }

  /* red cross */
  .day.done::before,
  .day.done::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 65%;
    height: 2px;
    background: #ef4444;
  }
  .day.done::before { transform: translate(-50%,-50%) rotate(45deg); }
  .day.done::after  { transform: translate(-50%,-50%) rotate(-45deg); }

  /* flame button */
  #markBtn {
    width: 68px;
    height: 68px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: linear-gradient(180deg,#fb923c,#f97316);
    box-shadow: 0 12px 24px rgba(249,115,22,.4);
  }

  #markBtn svg {
    width: 30px;
    height: 30px;
    fill: white;
  }

  #markBtn:active { transform: scale(.94); }
  #markBtn:disabled {
    opacity: .4;
    cursor: not-allowed;
    box-shadow: none;
  }
</style>
</head>
<body>

<div class="app">
    <button id="backBtn">‚Üê Back</button>
<script>
document.getElementById('backBtn').addEventListener('click', () => {
  window.history.back();
});
</script>

  <h1>Daily Streak</h1>
  <div class="streak" id="streakText">Streak: 0</div>

  <div class="calendar" id="calendar"></div>

  <button id="markBtn" aria-label="Mark today">
    <svg viewBox="0 0 384 512">
      <path d="M216 23.9c0-23.8-31.6-31.3-42.6-10.1C135.2 68.1 80 129.6 80 192c0 70.7 57.3 128 128 128s128-57.3 128-128c0-62.4-55.2-123.9-93.4-178.2C237.6-7.4 216 .1 216 23.9z"/>
    </svg>
  </button>
</div>

<script>
/* ================= IndexedDB ================= */
const DB_NAME = 'streakDB';
const STORE = 'days';

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function getAllDays() {
  const db = await openDB();
  return new Promise(res => {
    const tx = db.transaction(STORE, 'readonly');
    const r = tx.objectStore(STORE).getAllKeys();
    r.onsuccess = () => res(r.result || []);
  });
}

async function saveDay(key) {
  const db = await openDB();
  db.transaction(STORE, 'readwrite').objectStore(STORE).put(true, key);
}

/* ================= LOCAL DATE HELPERS (FIX) ================= */
function localDateKey(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function todayKey() {
  return localDateKey(new Date());
}

function keyFor(y,m,d) {
  return localDateKey(new Date(y,m,d));
}

/* ================= STREAK ================= */
function calcStreak(done) {
  let streak = 0;
  let d = new Date();
  while (done.has(localDateKey(d))) {
    streak++;
    d.setDate(d.getDate() - 1);
  }
  return streak;
}

/* ================= RENDER ================= */
async function render() {
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';

  const done = new Set(await getAllDays());
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();

  ['S','M','T','W','T','F','S'].forEach(w=>{
    const e = document.createElement('div');
    e.className = 'weekday';
    e.textContent = w;
    cal.appendChild(e);
  });

  const firstDay = new Date(y,m,1).getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();

  for (let i=0;i<firstDay;i++) cal.appendChild(document.createElement('div'));

  for (let d=1; d<=daysInMonth; d++) {
    const el = document.createElement('div');
    el.className = 'day';
    el.textContent = d;

    const key = keyFor(y,m,d);
    const cmp = new Date(y,m,d);
    const today = new Date(y,m,now.getDate());

    if (done.has(key)) el.classList.add('done');
    if (cmp.getTime() === today.getTime()) el.classList.add('today');
    if (cmp < today) el.classList.add('past');
    if (cmp > today) el.classList.add('future');

    cal.appendChild(el);
  }

  document.getElementById('streakText').textContent =
    `Streak: ${calcStreak(done)}`;

  document.getElementById('markBtn').disabled =
    done.has(todayKey());
}

/* ================= BUTTON ================= */
document.getElementById('markBtn').addEventListener('click', async () => {
  if ((await getAllDays()).includes(todayKey())) return;
  await saveDay(todayKey());
  render();
});

/* init */
render();
</script>
</body>
</html>
